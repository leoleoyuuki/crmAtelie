
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ======= UTILITY FUNCTIONS =======

    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      // UID do administrador
      return request.auth.uid == '3YuL6Ff7G9cHAV7xa81kyQF4bCw2';
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAccountActive() {
      // Check the user's profile document to see if their status is 'active'.
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'active';
    }
    
    function isCreatingOwnResource() {
        return isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    function isResourceOwner() {
        return isSignedIn() && resource.data.userId == request.auth.uid;
    }
    
    function isNotChangingOwner() {
        return request.resource.data.userId == resource.data.userId;
    }

    function isNotResettingTrial() {
      // A user cannot change trialStarted from true to false.
      // This prevents re-activating a trial period.
      return !(resource.data.trialStarted == true && request.resource.data.trialStarted == false);
    }

    // ======= COLLECTION RULES =======

    match /users/{userId} {
      // Qualquer usuário logado pode ler perfis para ver nome/foto.
      allow get: if isSignedIn();
      
      // Um usuário pode criar seu próprio perfil.
      allow create: if isOwner(userId) && request.resource.data.email == request.auth.token.email;
      
      // Um usuário pode atualizar seu próprio perfil. O webhook de pagamento também pode atualizar.
      allow update: if (isOwner(userId) && isNotResettingTrial()) || request.auth == null;
      
      // Perfis não são listáveis ou deletáveis pelos clientes.
      allow list, delete: if false; 
    }
    
    match /accessTokens/{tokenId} {
      // O admin pode ler e escrever (criar/atualizar) tokens.
      allow read, write: if isAdmin();
      
      // Qualquer usuário autenticado pode ler um token para tentar ativá-lo.
      allow get: if isSignedIn(); 
      // Um usuário autenticado pode atualizar um token (para marcá-lo como usado) durante o resgate.
      allow update: if isSignedIn(); 
    }

    match /customers/{customerId} {
      // Apenas usuários com conta ativa e que são donos do recurso podem ler/escrever.
      allow get, update, delete: if isAccountActive() && isResourceOwner();
      // Apenas usuários com conta ativa podem listar seus próprios clientes.
      allow list: if isAccountActive();
      // Apenas usuários com conta ativa podem criar clientes para si.
      allow create: if isAccountActive() && isCreatingOwnResource();
    }

    match /orders/{orderId} {
      // Apenas usuários com conta ativa e que são donos do recurso podem ler/escrever.
      allow get, update, delete: if isAccountActive() && isResourceOwner();
      // Apenas usuários com conta ativa podem listar seus próprios pedidos.
      allow list: if isAccountActive();
      // Apenas usuários com conta ativa podem criar pedidos para si.
      allow create: if isAccountActive() && isCreatingOwnResource();
    }

    match /priceTable/{itemId} {
      // Apenas usuários com conta ativa e que são donos do recurso podem ler/escrever.
      allow get, update, delete: if isAccountActive() && isResourceOwner();
      // Apenas usuários com conta ativa podem listar seus próprios itens.
      allow list: if isAccountActive();
      // Apenas usuários com conta ativa podem criar itens para si.
      allow create: if isAccountActive() && isCreatingOwnResource();
    }
    
    match /suggestions/{suggestionId} {
      // Qualquer usuário ativo pode criar uma sugestão.
      allow create: if isAccountActive() && request.resource.data.userId == request.auth.uid;
      // Apenas o admin pode ler/gerenciar sugestões.
      allow read, list, update, delete: if isAdmin();
    }

    match /materials/{materialId} {
        // Apenas usuários com conta ativa e que são donos do recurso podem ler/escrever.
        allow get, update, delete: if isAccountActive() && isResourceOwner();
        // Apenas usuários com conta ativa podem listar seus próprios materiais.
        allow list: if isAccountActive();
        // Apenas usuários com conta ativa podem criar materiais para si.
        allow create: if isAccountActive() && isCreatingOwnResource();
    }

    match /purchases/{purchaseId} {
      // Apenas usuários com conta ativa e que são donos do recurso podem ler/escrever.
      allow get, update, delete: if isAccountActive() && isResourceOwner();
      // Apenas usuários com conta ativa podem listar suas compras.
      allow list: if isAccountActive();
      // Apenas usuários com conta ativa podem criar registros de compra para si.
      allow create: if isAccountActive() && isCreatingOwnResource();
    }

    match /fixedCosts/{costId} {
      // Apenas usuários com conta ativa e que são donos do recurso podem ler/escrever.
      allow get, update, delete: if isAccountActive() && isResourceOwner();
      // Apenas usuários com conta ativa podem listar seus custos.
      allow list: if isAccountActive();
      // Apenas usuários com conta ativa podem criar registros de custos para si.
      allow create: if isAccountActive() && isCreatingOwnResource();
    }
    
    match /summaries/{summaryId} {
      // O dono do sumário pode ler.
      allow get: if isOwner(summaryId);
      // Ninguém pode listar sumários.
      allow list: if false;
      // O sumário só pode ser escrito pelo próprio usuário ou por um processo de servidor (webhook, não autenticado).
      allow write: if isOwner(summaryId) || request.auth == null;
    }
  }
}
